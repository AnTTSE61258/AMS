@using AMS.Service
@using Microsoft.AspNet.Identity
@{
    ViewBag.Title = "Home Page";
    Layout = "~/Views/Home/_socialNetworkLayout.cshtml";
    User curUser = ViewBag.curUser;
    List<UserAnswerSurvey> listUserAnswer = new List<UserAnswerSurvey>();
    HouseServices houseServices = new HouseServices();
    SurveyService surveyService = new SurveyService();
    QuestionService questionService = new QuestionService();
    AnswerService answerService = new AnswerService();
    UserAnswerService userAnswerService = new UserAnswerService();
    UserServices userServices = new UserServices();
    List<Survey> listSurveys = surveyService.GetListSurveys();
    string alert = "";
    foreach (var item in listSurveys)
    {
        listUserAnswer = (userAnswerService.GetListUserAnswerSurveysBySurveyId(item.Id));
        User currentUser = userServices.FindById(int.Parse(User.Identity.GetUserId()));
        int k = 0;
        if (item.Priority == 1)
        {
            foreach (var VARIABLE in listUserAnswer)
            {


                if (VARIABLE.UserId == currentUser.Id)
                {
                    k++;

                }

            }
            if (k != 1)
            {
                alert = "Bạn Có Một Survey Cần phải Làm!";
            }
        }
    }
}
<<<<<<< HEAD
<link rel="stylesheet" href="~/Content/css/FamilyTree.css" type="text/css" />
<script src="~/Scripts/amsScript/LoadFamilyTree.js"></script>
<script src="~/Scripts/amsScript/LoadUserProfile.js"></script>
=======
<style>
    .button {
        display: block;
        width: 100px;
        height: 35px;
        background: #4E9CAF;
        padding: 7px;
        text-align: center;
        border-radius: 5px;
        color: white;
        font-weight: bold;
    }

    .modalDialog {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 99999;
        display: none;
        opacity: 1;
        -webkit-transition: opacity 400ms ease-in;
        -moz-transition: opacity 400ms ease-in;
        transition: opacity 400ms ease-in;
    }

        .modalDialog > div {
            width: 400px;
            position: relative;
            margin: 10% auto;
            padding: 5px 20px 13px 20px;
            border-radius: 10px;
            background: #fff;
            background: #339999;
        }
>>>>>>> binhht12_6

    .close {
        background: #606061;
        color: #FFFFFF;
        line-height: 25px;
        position: absolute;
        right: -12px;
        text-align: center;
        top: -10px;
        width: 24px;
        text-decoration: none;
        font-weight: bold;
        -webkit-border-radius: 12px;
        -moz-border-radius: 12px;
        border-radius: 12px;
        -moz-box-shadow: 1px 1px 3px #000;
        -webkit-box-shadow: 1px 1px 3px #000;
        box-shadow: 1px 1px 3px #000;
    }

        .close:hover {
            background: #00d9ff;
        }
</style>
<div class="container-fluid">
    <div class="cover overlay">
        <img src="~/Content/images/banner-842.jpg" alt="cover">
        <a href="#" class="btn btn-cover"><i class="fa fa-pencil fa-fw"></i></a>
    </div>
    <div class="row">
        <div class="col-md-9">

            <ul class="timeline-list">
                <li class="media">
                    <div class="pull-left" onclick="LoadUserProfile(@curUser.Id)">


                        <img src="@(curUser.ProfileImage==null?"/Content/images/defaultProfile.png":curUser.ProfileImage)" alt="people" class="img-circle" width="80px" height="80px">
                        <div class="date">@curUser.Username</div>
                    </div>
                    <div class="media-body">
                        <div class="row">
                            <div class="col-md-10 col-lg-8">
                                <div class="panel panel-default share">

                                    <div class="panel-body" id="postStatusArea">
                                        <textarea id="postContent" name="status" class="form-control share-text" rows="8" placeholder="Chia sẽ những thông tin của bạn..."></textarea>
                                        <div class="row" style="height:auto;" id="previewList">

                                            <input type="file" id="uploadEditorImage" style="display:none" />
                                            <div id="progressBar" class="progress" style="width:200px" hidden="hidden">
                                                <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width:200px">
                                                </div>
                                            </div>

                                        </div>
                                        <input type="file" id="uploadEditorImage" style="display: none" />
                                        <div id="progressBar" class="progress" style="width: 200px" hidden="hidden">
                                            <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 200px">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="panel-footer share-buttons" id="postStatusArea">
                                        <div id="previewEmbed" class="row" style="height: auto;">
                                            <div id="previewContent">
                                            </div>
                                        </div>
                                        <a href="#postStatusArea" onclick="addImage()">
                                            <i class="fa fa-fw fa-photo"></i>
                                        </a>
                                        <a href="#postStatusArea" data-toggle="modal" data-target="#addEmbedModal">
                                            <i class="fa fa-fw fa-code"></i>
                                        </a>
                                        <a href="#postStatusArea" style="float:right">
                                            <i class="fa fa-map-marker"></i>
                                        </a>
                                        <button type="submit" class="btn btn-primary btn-xs pull-right display-none" style="margin-top:-12px" href="#" onclick="createNewPost()">Post</button>
                                       
                                    </div>
                                </div>
                            </div>
                        </div>
                </li>
            </ul>
            <ul class="timeline-list" id="timeline"></ul>
        </div>
        <div class="col-md-3">
            <div class="panel panel-default">
                <div class="panel-heading">
                    Thời tiết hôm nay
                </div>
                <div class="weather-svg">
                    <div class="today text-center">
                        <svg version="1.1" id="cloudDrizzleSunFill" class="climacon climacon_cloudDrizzleSunFill" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="15 15 70 70" enable-background="new 15 15 70 70" xml:space="preserve">
                        <g class="climacon_iconWrap climacon_iconWrap-cloudDrizzleSunFill">
                        <g class="climacon_componentWrap climacon_componentWrap-drizzle">
                        <path class="climacon_component climacon_component-stroke climacon_component-stroke_drizzle climacon_component-stroke_drizzle-left" d="M42.001,53.644c1.104,0,2,0.896,2,2v3.998c0,1.105-0.896,2-2,2c-1.105,0-2.001-0.895-2.001-2v-3.998C40,54.538,40.896,53.644,42.001,53.644z"></path>
                        <path class="climacon_component climacon_component-stroke climacon_component-stroke_drizzle climacon_component-stroke_drizzle-middle" d="M49.999,53.644c1.104,0,2,0.896,2,2v4c0,1.104-0.896,2-2,2s-1.998-0.896-1.998-2v-4C48.001,54.54,48.896,53.644,49.999,53.644z"></path>
                        <path class="climacon_component climacon_component-stroke climacon_component-stroke_drizzle climacon_component-stroke_drizzle-right" d="M57.999,53.644c1.104,0,2,0.896,2,2v3.998c0,1.105-0.896,2-2,2c-1.105,0-2-0.895-2-2v-3.998C55.999,54.538,56.894,53.644,57.999,53.644z"></path>
                                        </g>
                        <g class="climacon_componentWrap climacon_componentWrap_cloud">
                        <path class="climacon_component climacon_component-stroke climacon_component-stroke_cloud" d="M43.945,65.639c-8.835,0-15.998-7.162-15.998-15.998c0-8.836,7.163-15.998,15.998-15.998c6.004,0,11.229,3.312,13.965,8.203c0.664-0.113,1.338-0.205,2.033-0.205c6.627,0,11.998,5.373,11.998,12c0,6.625-5.371,11.998-11.998,11.998C57.168,65.639,47.143,65.639,43.945,65.639z"></path>
                        <path class="climacon_component climacon_component-fill climacon_component-fill_cloud" fill="#FFFFFF" d="M59.943,61.639c4.418,0,8-3.582,8-7.998c0-4.417-3.582-8-8-8c-1.601,0-3.082,0.481-4.334,1.291c-1.23-5.316-5.973-9.29-11.665-9.29c-6.626,0-11.998,5.372-11.998,11.999c0,6.626,5.372,11.998,11.998,11.998C47.562,61.639,56.924,61.639,59.943,61.639z"></path>
                                        </g>
                                    </g>
                                </svg>

                        <!-- cloudDrizzleSunFill -->
                        <div class="clearfix"></div>
                        <div class="details">
                            Today:
                            <strong>10° C</strong>
                        </div>
                    </div>
                </div>

            </div>
            <div class="panel panel-default">
                <div class="panel-heading panel-heading-gray" style="background-color:#25ad9f;color:white">
                    Thông báo
                </div>
                <div class="panel-body">
                    <div style="margin-bottom:10px">
                        <i class="fa fa-fw fa-info"></i>
                        Yêu cầu helpdesk của bạn đả được xử lí
                        <br />
                    </div>
                    <div style="margin-bottom:10px">
                        <i class="fa fa-fw fa-info"></i>
                        Bạn có 1 hóa đơn mới cần thanh toán
                        <br />
                    </div>
                    <div style="margin-bottom:10px">
                        <i class="fa fa-fw fa-info"></i>
                        Yêu cầu helpdesk của bạn đả được xử lí
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="addEmbedModal" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Thêm mã nhúng</h4>
            </div>
            <div class="modal-body">
                <input class="form-control" id="embedCode" placeholder="Copy và paste đoạn mã nhúng của bạn vào đây" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="saveEmbedCode()">Lưu lại</button>
            </div>
        </div>

    </div>
</div>
<button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal">Open Modal</button>





@{
    if (alert!="")
    {
        <div id="openModal" class="modalDialog">
            <div class="modal-content">

                <a href="#close" title="Close" class="close" style="color: white">X</a>
                <div class="modal-header" style="color: white"><b>Thông Báo</b></div>
                <div class="modal-body">
                    <h4 style="color: white">@alert</h4>
                </div>

                <div class="modal-footer">
                    @*<button type="button" class="btn btn-default" data-dismiss="modal">Hủy</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal" >Hủy</button>*@
                    <a href="@Url.Action("DoSurvey", "Survey")" class="button">Làm ngay</a>
                </div>
            </div>
        </div>
    }
}
@*<div id="myModall1" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">Báo cáo</h4>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Tắt</button>

                </div>
            </div>
        </div>
    </div>*@

<script>
    $(document).ready(function () {
        $('.modalDialog').fadeIn();

        $('.close').on('click', function (event) {
            event.preventDefault();
            /* Act on the event */

            $('.modalDialog').fadeOut();

        });
    });
    var listUploadImage = [];
    function addImage() {
        $("#uploadEditorImage").click();

    }
    function saveEmbedCode() {
        alert("saveEmbedCode");
        var embedContent = $("#embedCode").val();
        $("#previewContent").html(embedContent);
    }
    function createNewPost() {
        alert('createNewPost');
        $.ajax({
            url: "/Post/Create",
            type: "POST",
            datatype: 'json',
            data: {
                images: listUploadImage,
                content: $("#postContent").val(),
                embeded: $("#embedCode").val(),

            },

            success: function (successData) {
                if (successData == 'success') {
                    clearCreatePostForm();
                    reloadFeed();
                }
            },
            error: function (er) {
                alert(er);
                //progessBar(false);
            }

        });

    }

    $("#uploadEditorImage").change(function () {
        var data = new FormData();

        data.append("dir", "@SLIM_CONFIG.dirPostImage");

        var files = $("#uploadEditorImage").get(0).files;
        if (files.length > 0) {
            data.append("HelpSectionImages", files[0]);
        }

        // progessBar(true);
        $.ajax({
            url: "/Image/Upload/",
            type: "POST",
            processData: false,
            contentType: false,
            data: data,

            success: function (successData) {
                addImageToPreviewList(successData, listUploadImage.length);
                listUploadImage[listUploadImage.length] = successData;
                // progessBar(false);

            },
            error: function (er) {
                alert(er);
                //progessBar(false);
            }

        });
    });
    $(document).ready(function () {
        loadAllPost();

    });

    function loadAllPost() {
        $.ajax({
            url: "/Post/getPost",
            type: "GET",
            datatype: 'json',
            data: {
                idToken: -1,
            },
            success: function (successData) {
                var obj = JSON.parse(successData);
                $.each(obj, function (index, jsonObject) {
                    addPostToTimeline(index, jsonObject);
                    getImagesForPost(index, jsonObject["Id"]);
                    getUserProfileForPost(index, jsonObject["Id"]);
                    getCommentsForPost(jsonObject["Id"]);
                  
                });
            },
            error: function (er) {
                alert(er);
            }

        });
    }
    function getUserProfileForPost(index, id) {
        if (id == null) {
            alert("postid = nul");
            return;
        }
        $.ajax({
            url: "/Post/getUserForPost",
            type: "GET",
            data: {
                postId: id,
            },
            success: function (successData) {
                // alert(successData)
                var obj = JSON.parse(successData);
                if (obj['ProfileImage'] === null) {
                    $('#userImagePost' + id).attr("src", "/Content/images/defaultProfile.png");
                } else {
                    $('#userImagePost' + id).attr("src", obj["ProfileImage"]);

                }
                $('#userNamePost' + id).html(obj["Username"])
                $('#userHrefPost' + id).attr("href", "/Profile/" + obj["Id"])
   
                $('#userLoadProfilePost' + id).attr("onclick", "LoadUserProfile("+obj["Id"]+",true)")

            },
            error: function (er) {
                alert(er)
            }

        });
    }
    function addPostToTimeline(index, postObject) {
        $("#timeline").append('<li class="media">'


                       + '<div class="pull-left" id="userLoadProfilePost'+postObject['Id']+'">'
                        

                            + '<img id="userImagePost' + postObject['Id'] + '" src="images/people/110/woman-5.jpg" alt="people" class="img-circle" width="80" height="80">'
                            + '<div id="userNamePost' + postObject['Id'] + '" class="date">3 MAY</div>'
                     
                        + '</div>'

                        + '<div class="media-body">'
                            + '<div class="panel panel-default">'
                                + '<div class="panel-body" >'
                                    + '<p>' + postObject['Body'] + '</p>'
                                    + '<div class="row" id="imagesPost' + postObject['Id'] + '" style="height:auto">'
                                    + '</div>'
                                    + '<div class="row" style="height:auto;">'
                                    + postObject['EmbedCode']
                                    + '</div>'
                                + '</div>'
                                + '<div class="view-all-comments" id="countComment' + postObject['Id'] + '"><a href="#"><i class="fa fa-comments-o"></i> View all</a> 10 comments</div>'
                                + '<ul class="comments" id="commentsArea' + postObject['Id'] + '">'

                                + '</ul>'
                                + '<ul class="comments">'
                                 + '<li class="comment-form">'
                                        + '<div class="input-group">'
                                            + '<input id="contentDetail' + postObject['Id'] + '" type="text" class="form-control">'
                                            + '<span class="input-group-addon">'
                                           
                                                + '<button class="btn btn-success" onclick="addComment(' + postObject['Id'] + ')">Bình luận</button>'
                                            + '</span>'
                                        + '</div>'
                                    + '</li>'
                                + '</ul>'
                            + '</div>'
                        + '</div>'
                    + '</li>'
 )

    }
 
    function addComment(postId) {
        $.ajax({
            url: "/Post/CreateComment",
            type: "POST",
            data: {
                detail: $("#contentDetail" + postId).val(),
                postId: postId,
            },
            success: function (successData) {
                if (successData === 'success') {
                    $("#commentsArea" + postId).html("");
                    getCommentsForPost(postId)
                    $("#contentDetail" + postId).val("")
                } else {
                    alert(successData)
                }
            },
            error: function (er) {
                alert(er)
            }

        });
    }

    function getCommentsForPost(postid) {
        if (postid == null) {
            alert("postid == null");
            return;
        }
        $.ajax({
            url: "/Post/getCommentsForPost",
            type: "GET",
            data: {
                postId: postid,
            },
            success: function (successData) {
                var obj = JSON.parse(successData);
                $("#countComment" + postid).html(obj.length + " bình luận")
                $.each(obj, function (index, comment) {
                    addCommentToCommentArea(postid, comment)
                });
            },
            error: function (er) {
                alert(er)
            }

        });
    }
    function addCommentToCommentArea(postId, comment) {
        $("#commentsArea" + postId).append('<li>'
                                        + '<div class="media">'
                                            + '<a href="" class="pull-left">'
                                                + '<img  src="' + comment['userProfile'] + '" class="media-object" style="width:50px">'
                                            + '</a>'
                                            + '<div class="media-body">'
                                                + '<a href="/Profile/' + comment['userId'] + '" class="comment-author">' + comment['username'] + ': </a>'
                                                + '<span>' + comment['detail'] + '</span>'
                                                + '<div class="comment-date">' + timeSince(comment['createdDate']) + ' trước </div>'
                                            +'</div>'
                                        +'</div>'

                                    + '</li>')

    }


    function timeSince(dateString) {
        
        var date = new Date(dateString);
        var seconds = Math.floor((new Date() - date) / 1000);

        var interval = Math.floor(seconds / 31536000);

        if (interval >= 1) {
            return interval + " năm";
        }
        interval = Math.floor(seconds / 2592000);
        if (interval >= 1) {
            return interval + " tháng";
        }
        interval = Math.floor(seconds / 86400);
        if (interval >= 1) {
            return interval + " ngày";
        }
        interval = Math.floor(seconds / 3600);
        if (interval >= 1) {
            return interval + " giờ";
        }
        interval = Math.floor(seconds / 60);
        if (interval >= 1) {
            return interval + " phút";
        }
        return Math.floor(seconds) + " giây";

    }



    function getImagesForPost(index, id) {
        if (id == null) {
            alert("postid = nul");
            return;
        }
        $.ajax({
            url: "/Post/getImagesForPost",
            type: "GET",
            data: {
                postId: id,
            },
            success: function (successData) {
                var obj = JSON.parse(successData);
                $.each(obj, function (index, image) {
                    addImageToPost(image['url'], id, (90 / obj.length))

                });

            },
            error: function (er) {
                alert(er)
            }

        });
    }
    function addImageToPost(imageUrl, postId, width) {
        $("#imagesPost" + postId).append('<img src="' + imageUrl + '" style="width:' + width + '%;height:auto;margin-right:5px">')

    }

    function addImageToPreviewList(dir, position) {
        $("#previewList").prepend('<div id="previewImage' + position + '" style="height:100px;width:100px;float:left;position:relative"><img onclick="removePreview(' + position + ')" src="/Content/images/delete.png" style="position:absolute;top:0px;right:0px;width:20px;height:20px"/><img src="' + dir + '" style="max-width:100%;max-height:100%"/></div>')
    }
    function removePreview(position) {
        $('#previewImage' + position + '').hide();
        listUploadImage[position] = "";

    }
    function reloadFeed() {
        //clear all feed
        $("#timeline").html("");
        loadAllPost();
    }
    function clearCreatePostForm() {
        var embedContent = "";
        $("#previewContent").html(embedContent);
        listUploadImage = [];
        $("#previewList").html('');
        $("#postContent").val('');
    }
</script>